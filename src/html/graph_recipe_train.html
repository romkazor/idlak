<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: Decoding-graph creation recipe (training time)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('graph_recipe_train.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Decoding-graph creation recipe (training time) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Our graph creation recipe during training time is simpler than during test time, mainly because we do not need the disambiguation symbols.</p>
<p>We will assume that you have already read the <a class="el" href="graph_recipe_train.html">test-time</a> version" of this recipe.</p>
<p>In training time we use the same HCLG formalism as in test time, except that G consists of just a linear acceptor corresponding to the training transcript (of course, this setup is easy to extend to cases where there is uncertainty in the transcripts).</p>
<h1><a class="anchor" id="graph_recipe_command"></a>
Command-line programs involved in decoding-graph creation</h1>
<p>Here we explain what happens at the script level in a typical training script; below we will dig into what happens inside the programs. Suppose we have built a tree and model. The following command creates an archive (c.f. <a class="el" href="io.html#io_sec_tables">The Table concept</a>) that contains the graph HCLG corresponding to each of the training transcripts. </p><pre class="fragment">compile-train-graphs $dir/tree $dir/1.mdl data/L.fst ark:data/train.tra \
   ark:$dir/graphs.fsts
</pre><p> The input file train.tra is a file containing integer versions of the training transcripts, e.g. a typical line might look like: </p><pre class="fragment">011c0201 110906 96419 79214 110906 52026 55810 82385 79214 51250 106907 111943 99519 79220
</pre><p> (the first token is the utterance id). The output of this program is the archive graphs.fsts; it contains an FST (in binary form) for each utterance id in train.tra. The FSTs in this archive correspond to HCLG, except that there are no transition probabilities (by default, compile-train-graphs has &ndash;self-loop-scale=0 and &ndash;transition-scale=0). This is because these graphs will be used for multiple stages of training and the transition probabilities will change, so we add them in later. But the FSTs on the archive will have probabilities that arise from silence probabilities (these probabilities are encoded into L.fst), and if we were using pronunciation probabilities these would be present too.</p>
<p>A command that reads these archives and decodes the training data, producing state-level alignments (c.f. <a class="el" href="hmm.html#hmm_alignment">Alignments in Kaldi</a>) is as follows; we will briefly review this command, although our main focus on this page is the graph creation itself. </p><pre class="fragment">gmm-align-compiled \
  --transition-scale=1.0 --acoustic-scale=0.1 --self-loop-scale=0.1 \
  --beam=8 --retry-beam=40 \
   $dir/$x.mdl ark:$dir/graphs.fsts \
   "ark:add-deltas --print-args=false scp:data/train.scp ark:- |" \
   ark:$dir/cur.ali
</pre><p> The first three argument are probability scales (c.f. <a class="el" href="hmm.html#hmm_scale">Scaling of transition and acoustic probabilities</a>). The transition-scale and self-loop-scale options are there because this program adds the transition probabilities to the graph before decoding (c.f. <a class="el" href="hmm.html#hmm_graph_add_transition_probs">Adding transition probabilities to FSTs</a>). The next options are the beams; we use an initial beam, and then if alignment fails to reach the end state we use another beam. Since we apply a scale of 0.1 the acoustics, we would have to multiply these beams by 10 to get figures comparable to acoustic likelihoods. The program requires the model; $x.mdl would expand to 1.mdl or 2.mdl, according to the iteration. It reads the graphs from the archive (graphs.fsts). The argument in quotes is evaluated as a pipe (minus the "ark:" and "|"), and is interpreted as an archive indexed by utterance id, containing features. The output goes to cur.ali, and if written in text form it would look like the .tra file described above, although the integers now correspond not to word-ids but transition-ids (c.f. <a class="el" href="hmm.html#transition_model_identifiers">Integer identifiers used by TransitionModel</a>).</p>
<p>We note that these two stages (graph creation and decoding) can be done by a single command-line program, gmm-align, which compiles the graphs as they are needed. Because graph creation takes a fairly significant amount of time, any time the graphs will be needed more than once we write them to disk.</p>
<h1><a class="anchor" id="graph_recipe_internal"></a>
Internals of graph creation</h1>
<p>The graph creation done in training time, whether from the program compile-train-graphs or from gmm-align, is done by the same code: the class <a class="el" href="classkaldi_1_1TrainingGraphCompiler.html">TrainingGraphCompiler</a>. Its behaviour when compiling graphs one by one is as follows:</p>
<p>In initialization:</p><ul>
<li>Add the subsequential loop (c.f. <a class="el" href="graph_recipe_test.html#graph_c">Making the context transducer</a>) to the lexicon L.fst, make sure it is sorted on its output label, and store it.</li>
</ul>
<p>When compiling a transcript, it does the following:</p><ul>
<li>Make a linear acceptor corresponding to the word sequence (G)</li>
<li>Compose it (using TableCompose) with the lexicon to get an FST (LG) with phones on the input and words on the output; this FST contains pronunciation alternatives and optional silence.</li>
<li>Create a new context FST "C" that will be expanded on demand.</li>
<li>Compose C with LG to get CLG; the composition uses a special Matcher that expands C on demand.</li>
<li>Call the function GetHTransducer to get the transducer H (this covers just the context-dependent phones that were seen).</li>
<li>Compose H with CLG to get HCLG (this will have transition-ids on the input and words on the output, but no self-loops)</li>
<li>Determinize HCLG with the function DeterminizeStarInLog; this casts to the log semiring (to preserve stochasticity) before determinizing with epsilon removal.</li>
<li>Minimize HCLG with MinimizeEncoded (this does transducer minimization without weight-pushing, to preserve stochasticity).</li>
<li>Add self-loops.</li>
</ul>
<p>The <a class="el" href="classkaldi_1_1TrainingGraphCompiler.html">TrainingGraphCompiler</a> class has a function CompileGraphs() that will combine a number of graphs in a batch. This is used in the tool compile-train-graphs to speed up the graph compilation. The main reason it helps to do it in a batch is that when we create the H transducer, we only have to process each seen context-window once, even if it was used in many of the instances of CLG.</p>
<p>The reason that we can determinize without first adding disambiguation symbols is that HCLG in this case is functional (since any accepted input-label sequence is transuced to the same string) and acyclic; any acyclic FST has the twins property, and any functional FST with the twins property is determinizable. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Kaldi</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
