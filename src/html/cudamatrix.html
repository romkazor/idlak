<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: The CUDA Matrix library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('cudamatrix.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The CUDA <a class="el" href="classkaldi_1_1Matrix.html" title="A class for storing matrices. ">Matrix</a> library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The CUDA matrix library provides access to GPU-based matrix operations with an interface similar to <a class="el" href="matrix.html">The Kaldi Matrix library</a>.</p>
<p>The general principle is that if you want to be able to run a particular part of the computation the GPU, you would declare the relevant quantities as type <a class="el" href="classkaldi_1_1CuMatrix.html" title="This class represents a matrix that&#39;s stored on the GPU if we have one, and in memory if not...">CuMatrix</a> or <a class="el" href="classkaldi_1_1CuVector.html">CuVector</a> instead of <a class="el" href="classkaldi_1_1Matrix.html" title="A class for storing matrices. ">Matrix</a> or <a class="el" href="classkaldi_1_1Vector.html" title="A class representing a vector. ">Vector</a>. Then, if you have configured Kaldi to use the GPU and if the Kaldi program you are running has initialized access to the GPU, those operations will run on the GPU. Otherwise, they will run on the CPU. <a class="el" href="classkaldi_1_1CuMatrix.html" title="This class represents a matrix that&#39;s stored on the GPU if we have one, and in memory if not...">CuMatrix</a> and <a class="el" href="classkaldi_1_1CuVector.html">CuVector</a> quantities store their contents in GPU memory space, if you have configured for GPU and your program has initialized the GPU device.</p>
<p>You can't mix <a class="el" href="classkaldi_1_1CuMatrix.html" title="This class represents a matrix that&#39;s stored on the GPU if we have one, and in memory if not...">CuMatrix</a> and <a class="el" href="classkaldi_1_1CuVector.html">CuVector</a> with <a class="el" href="classkaldi_1_1Matrix.html" title="A class for storing matrices. ">Matrix</a> and <a class="el" href="classkaldi_1_1Vector.html" title="A class representing a vector. ">Vector</a> in matrix operations, because they live in different memory spaces, but you can copy from one to the other. Kaldi does not try to automatically decide which operations are best done on GPU: it is all under the control of the programmer.</p>
<p>If the <code>configure</code> script sees that the NVidia compilation tool <code>nvcc</code> is on the path when it is run, it assumes you want to compile for GPU, and will define <code>HAVE_CUDA=1</code> and set other Makefile variables to enable GPU compilation. You can disable this if you don't want it by calling <code>configure</code> with <code>&ndash;use-cuda=no</code>. If the script doesn't find the location where you installed the CUDA toolkit but you want to use it, you can use an option like <code>&ndash;cudatk-dir=/opt/cuda-4.2</code>. If you want to tell whether Kaldi has been configured to use CUDA, you can grep for <code>CUDATKDIR</code> in <code>kaldi.mk</code>; if the string appears, then it has been configured to use CUDA. In scripts, you can check the return status of the program <code>cuda-compiled</code>: it returns success (0) if you compiled for CUDA.</p>
<p>You can also tell from the logs whether a program is using the GPU. If it is using the GPU, you'll see lines like this near the top of the program's output: </p><pre class="fragment">LOG (nnet-train-simple:IsComputeExclusive():cu-device.cc:229) CUDA setup operating under Compute Exclusive Mode.
LOG (nnet-train-simple:FinalizeActiveGpu():cu-device.cc:194) The active GPU is [1]: Tesla K10.G2.8GB  \
    free:3519M, used:64M, total:3583M, free/total:0.982121 version 3.0
</pre><p> In addition to configuring at the Makefile to use CUDA, if any individual program wants to use GPU operations it needs to have code like the following: </p><pre class="fragment">#if HAVE_CUDA==1
    CuDevice::Instantiate().SelectGpuId(use_gpu);
#endif
</pre><p> where <code>use_gpu</code> is a string, typically a command-line option, that can take the following values:</p>
<ul>
<li><code>"yes"</code>: use the GPU (or crash if one is not available).</li>
<li><code>"no"</code> don't use the GPU.</li>
<li><code>"optional"</code> use the GPU if the machine it's running on has GPUs attached.</li>
<li><code>"wait"</code>: like <code>"yes"</code> but if the GPUs are running other processes, the program will wait indefinitely until one becomes free.</li>
</ul>
<p>If a program doesn't take the <code>&ndash;use-gpu</code> command line option, that generally means that it hasn't been programmed to support the use of GPU operations, even if the code it runs contains the <a class="el" href="classkaldi_1_1CuVector.html">CuVector</a> and <a class="el" href="classkaldi_1_1CuMatrix.html" title="This class represents a matrix that&#39;s stored on the GPU if we have one, and in memory if not...">CuMatrix</a> types. Usually we only run specific tasks on the GPU- mainly neural net training.</p>
<p>NVidia GPUs (which is the only kind Kaldi supports) have various "compute modes": "default", "process exclusive", "thread exclusive". This controls whether or not the GPU is configured to run multiple processes at the same time. Kaldi is intended to be run in "exclusive mode"; whether it's process exclusive or thread exclusive doesn't matter. You can find out what mode your GPU is running in as follows: </p><pre class="fragment"># nvidia-smi  --query | grep 'Compute Mode'
    Compute Mode                    : Exclusive_Process
</pre><p> You can set the correct mode by typing <code>nvidia-smi -c 3</code>. You might want to do this in a startup script so it happens each time you reboot.</p>
<p>Rather than calling the malloc and free functions that NVidia provides, Kaldi does caching of previously released memory so that we don't have to incur the overhead of NVidia's malloc. This was done because at one point we were running in Amazon's cloud and found that NVidia's malloc was very slow. This was probably caused by the virtualization, and we're not sure whether that problem still exists. Anyway, the memory caching can cause a problem if for some reason you run using the default (non-exclusive) compute mode, because it can cause allocation failures. You can disable it at the code level by calling <code>CuDevice::Instantiate().DisableCaching()</code>, if needed. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Kaldi</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
